<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Ç≠„É£„É≥„Éá„Ç£„Ç≤„Éº„É†</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #87ceeb 0%, #e0f6ff 50%, #98fb98 100%);
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      color: #ff69b4;
      text-shadow: 2px 2px 0 #fff;
      margin-bottom: 10px;
      font-size: 1.8rem;
    }
    .game-area {
      position: relative;
      width: 100%;
      max-width: 560px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    #gameCanvas {
      display: block;
      width: 100%;
      height: 400px;
      background: linear-gradient(180deg, #87ceeb 0%, #b0e0e6 30%, #90ee90 70%, #7ccd7c 100%);
    }
    .ui {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #fff5f8;
      border-top: 3px solid #ffb6c1;
    }
    .score-box {
      font-size: 1.2rem;
      color: #c71585;
      font-weight: bold;
    }
    .score-box span { font-size: 1.5rem; }
    .jump-btn {
      padding: 14px 32px;
      font-size: 1.2rem;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(180deg, #ff69b4, #ff1493);
      border: none;
      border-radius: 24px;
      box-shadow: 0 4px 0 #c71585;
      cursor: pointer;
      user-select: none;
      transition: transform 0.05s;
    }
    .jump-btn:hover { background: linear-gradient(180deg, #ff85c1, #ff69b4); }
    .jump-btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 #c71585;
    }
    .message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 24px 32px;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      z-index: 10;
      display: none;
    }
    .message.show { display: block; }
    .message h2 { color: #ff69b4; margin-bottom: 8px; }
    .message p { color: #333; margin-bottom: 16px; }
    .message button {
      padding: 10px 24px;
      font-size: 1rem;
      background: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üç¨ „Ç≠„É£„É≥„Éá„Ç£„ÇíÈõÜ„ÇÅ„Çà„ÅÜ üç¨</h1>
  <p style="color:#666; margin-bottom:12px;">„Ç¥„Éº„É´„Åæ„Åß„Å´„Ç≠„É£„É≥„Éá„Ç£„Çí„Åü„Åè„Åï„ÇìÈõÜ„ÇÅ„Çà„ÅÜÔºÅ</p>
  <div class="game-area">
    <canvas id="gameCanvas" width="560" height="400"></canvas>
    <div class="message" id="startMessage">
      <h2>„Ç≠„É£„É≥„Éá„Ç£„Ç≤„Éº„É†</h2>
      <p>„Ç∏„É£„É≥„Éó„Éú„Çø„É≥„Åß„Ç∏„É£„É≥„Éó„Åó„Å¶<br>„Ç≠„É£„É≥„Éá„Ç£„ÇíÈõÜ„ÇÅ„Çà„ÅÜÔºÅ</p>
      <button id="startBtn">„Çπ„Çø„Éº„Éà</button>
    </div>
    <div class="message" id="goalMessage">
      <h2>„Ç¥„Éº„É´ÔºÅ</h2>
      <p id="finalScore">„Ç≠„É£„É≥„Éá„Ç£ 0 ÂÄã ÈõÜ„ÇÅ„Åü„ÇàÔºÅ</p>
      <button id="retryBtn">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
    </div>
    <div class="ui">
      <div class="score-box">üç¨ <span id="score">0</span> ÂÄã</div>
      <button class="jump-btn" id="jumpBtn">„Ç∏„É£„É≥„Éó</button>
    </div>
  </div>

  <script>
    (function() {
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const jumpBtn = document.getElementById('jumpBtn');
      const scoreEl = document.getElementById('score');
      const startMessage = document.getElementById('startMessage');
      const goalMessage = document.getElementById('goalMessage');
      const startBtn = document.getElementById('startBtn');
      const retryBtn = document.getElementById('retryBtn');
      const finalScoreEl = document.getElementById('finalScore');

      const GRAVITY = 0.6;
      const JUMP_FORCE = -16;
      const SCROLL_SPEED = 3;
      const GIRL_WIDTH = 36;
      const GIRL_HEIGHT = 52;
      const GIRL_SCALE = 1.5;
      const GIRL_DISPLAY_WIDTH = GIRL_WIDTH * GIRL_SCALE;
      const GIRL_DISPLAY_HEIGHT = GIRL_HEIGHT * GIRL_SCALE;
      const ITEM_SIZE = 40;
      const GOAL_DISTANCE = 3600;
      const GROUND_Y = 340;

      let audioCtx = null;
      function getAudioCtx() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
      }
      function playJumpSound() {
        try {
          const ctx = getAudioCtx();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = 380;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.15, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.12);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.12);
        } catch (e) {}
      }
      function playCollectSound() {
        try {
          const ctx = getAudioCtx();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = 880;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.2, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.15);
        } catch (e) {}
      }

      const imgCandy = new Image();
      imgCandy.src = 'candy.png';
      const imgSoftcream = new Image();
      imgSoftcream.src = 'softcream.png';
      const imgCandygirl = new Image();
      imgCandygirl.src = 'candygirl.png';

      let gameRunning = false;
      let scrollX = 0;
      let girlY = GROUND_Y - GIRL_DISPLAY_HEIGHT;
      let vy = 0;
      let score = 0;
      let candies = [];
      let nextCandyAt = 0;
      let lastTime = 0;

      function randomBetween(a, b) {
        return a + Math.random() * (b - a);
      }

      function init() {
        scrollX = 0;
        girlY = GROUND_Y - GIRL_DISPLAY_HEIGHT;
        vy = 0;
        score = 0;
        candies = [];
        nextCandyAt = 200;
        scoreEl.textContent = '0';
        goalMessage.classList.remove('show');
      }

      function drawGround() {
        const tileW = 48;
        const start = Math.floor(scrollX / tileW) * tileW;
        for (let x = start; x < scrollX + canvas.width + tileW; x += tileW) {
          ctx.fillStyle = '#8B4513';
          ctx.fillRect(x - scrollX, GROUND_Y, tileW, canvas.height - GROUND_Y);
          ctx.fillStyle = '#228B22';
          ctx.fillRect(x - scrollX, GROUND_Y, tileW, 8);
        }
      }

      function drawGirl() {
        const x = 80;
        const localY = girlY;
        if (imgCandygirl.complete && imgCandygirl.naturalWidth > 0) {
          ctx.save();
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.globalCompositeOperation = 'source-over';
          ctx.globalAlpha = 1;
          ctx.drawImage(imgCandygirl, x, localY, GIRL_DISPLAY_WIDTH, GIRL_DISPLAY_HEIGHT);
          ctx.restore();
        } else {
          ctx.save();
          ctx.translate(x, localY);
          ctx.scale(GIRL_SCALE, GIRL_SCALE);
          ctx.fillStyle = '#ffb6c1';
          ctx.beginPath();
          ctx.ellipse(GIRL_WIDTH/2, 14, 10, 12, 0, 0, Math.PI*2);
          ctx.fill();
          ctx.strokeStyle = '#ff69b4';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.fillStyle = '#ff69b4';
          ctx.fillRect(6, 26, 24, 22);
          ctx.fillRect(4, 46, 10, 8);
          ctx.fillRect(22, 46, 10, 8);
          ctx.fillStyle = '#ffc0cb';
          ctx.beginPath();
          ctx.arc(GIRL_WIDTH/2, 10, 4, 0, Math.PI*2);
          ctx.fill();
          ctx.restore();
        }
      }

      function getItemSize(c) {
        if (c.type === 'softcream' && imgSoftcream.complete && imgSoftcream.naturalWidth > 0) {
          const scale = ITEM_SIZE / Math.max(imgSoftcream.naturalWidth, imgSoftcream.naturalHeight);
          return {
            w: imgSoftcream.naturalWidth * scale,
            h: imgSoftcream.naturalHeight * scale
          };
        }
        return { w: ITEM_SIZE, h: ITEM_SIZE };
      }

      function drawCandy(c) {
        const x = c.x - scrollX;
        const y = c.y;
        const size = getItemSize(c);
        if (x < -size.w || x > canvas.width + size.w) return;
        const img = c.type === 'softcream' ? imgSoftcream : imgCandy;
        if (img && img.complete && img.naturalWidth > 0) {
          ctx.save();
          if (c.type === 'softcream') {
            const scale = ITEM_SIZE / Math.max(img.naturalWidth, img.naturalHeight);
            const w = img.naturalWidth * scale;
            const h = img.naturalHeight * scale;
            ctx.translate(x + w/2, y + h/2);
            ctx.rotate(c.rot || 0);
            ctx.translate(-w/2, -h/2);
            ctx.drawImage(img, 0, 0, w, h);
          } else {
            ctx.translate(x + ITEM_SIZE/2, y + ITEM_SIZE/2);
            ctx.rotate(c.rot || 0);
            ctx.translate(-ITEM_SIZE/2, -ITEM_SIZE/2);
            ctx.drawImage(img, 0, 0, ITEM_SIZE, ITEM_SIZE);
          }
          ctx.restore();
        } else {
          ctx.save();
          ctx.translate(x + size.w/2, y + size.h/2);
          ctx.rotate(c.rot || 0);
          ctx.translate(-size.w/2, -size.h/2);
          ctx.fillStyle = c.color || '#ff69b4';
          ctx.fillRect(4, 10, size.w - 8, size.h - 16);
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.strokeRect(4, 10, size.w - 8, size.h - 16);
          ctx.restore();
        }
      }

      function drawGoal() {
        const goalX = GOAL_DISTANCE - scrollX;
        if (goalX > canvas.width + 50) return;
        ctx.fillStyle = '#ffd700';
        ctx.fillRect(goalX, GROUND_Y - 80, 24, 80);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 14px sans-serif';
        ctx.fillText('GOAL', goalX + 2, GROUND_Y - 30);
      }

      function spawnCandy() {
        const baseX = scrollX + canvas.width + randomBetween(80, 220);
        const y = randomBetween(20, GROUND_Y - ITEM_SIZE - 10);
        const type = Math.random() < 0.5 ? 'candy' : 'softcream';
        const colors = ['#ff69b4', '#ff1493', '#ffb6c1', '#ff85c1', '#ffc0cb'];
        candies.push({
          x: baseX,
          y: y,
          type: type,
          color: colors[Math.floor(Math.random() * colors.length)],
          rot: randomBetween(0, 0.3)
        });
      }

      function checkCandyCollision() {
        const girlLeft = 80;
        const girlRight = 80 + GIRL_DISPLAY_WIDTH;
        const girlTop = girlY;
        const girlBottom = girlY + GIRL_DISPLAY_HEIGHT;
        candies = candies.filter(c => {
          const size = getItemSize(c);
          const cx = c.x - scrollX;
          const cr = cx + size.w;
          const cb = c.y + size.h;
          if (girlRight >= cx && girlLeft <= cr && girlBottom >= c.y && girlTop <= cb) {
            score++;
            scoreEl.textContent = score;
            playCollectSound();
            return false;
          }
          return true;
        });
      }

      function update(dt) {
        if (!gameRunning) return;
        scrollX += SCROLL_SPEED;
        vy += GRAVITY;
        girlY += vy;
        if (girlY >= GROUND_Y - GIRL_DISPLAY_HEIGHT) {
          girlY = GROUND_Y - GIRL_DISPLAY_HEIGHT;
          vy = 0;
        }
        if (scrollX >= nextCandyAt) {
          spawnCandy();
          nextCandyAt = scrollX + randomBetween(150, 350);
        }
        candies.forEach(c => { c.rot += 0.02; });
        checkCandyCollision();
        if (scrollX >= GOAL_DISTANCE) {
          gameRunning = false;
          finalScoreEl.textContent = `„Ç≠„É£„É≥„Éá„Ç£ ${score} ÂÄã ÈõÜ„ÇÅ„Åü„ÇàÔºÅ`;
          goalMessage.classList.add('show');
        }
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawGround();
        candies.forEach(drawCandy);
        drawGirl();
        drawGoal();
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.font = '14px sans-serif';
        ctx.fillText(`„Ç¥„Éº„É´„Åæ„Åß ${Math.max(0, Math.ceil((GOAL_DISTANCE - scrollX) / 50))} m`, 10, 24);
      }

      function loop(t) {
        const dt = Math.min((t - lastTime) / 16, 4);
        lastTime = t;
        update(dt);
        draw();
        requestAnimationFrame(loop);
      }

      jumpBtn.addEventListener('click', () => {
        if (!audioCtx) getAudioCtx();
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        if (!gameRunning) return;
        if (girlY >= GROUND_Y - GIRL_DISPLAY_HEIGHT - 2) {
          vy = JUMP_FORCE;
          playJumpSound();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.code !== 'Space') return;
        e.preventDefault();
        if (startMessage.classList.contains('show')) {
          startBtn.click();
        } else {
          jumpBtn.click();
        }
      });

      startBtn.addEventListener('click', () => {
        startMessage.classList.remove('show');
        getAudioCtx();
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        init();
        gameRunning = true;
        lastTime = performance.now();
      });

      retryBtn.addEventListener('click', () => {
        goalMessage.classList.remove('show');
        init();
        gameRunning = true;
        lastTime = performance.now();
      });

      startMessage.classList.add('show');
      requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Ëá™Âãï„ÅßËµ∞„Çã„Ç≠„É£„É©„ÇØ„Çø„Éº„Çí„Ç∏„É£„É≥„Éó„ÅßÊìç‰Ωú„Åô„Çã„Ç≤„Éº„É†">
    <meta name="theme-color" content="#4a90e2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>„É©„É≥„Éã„É≥„Ç∞„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.2s;
            font-size: 1em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .back-link:hover {
            opacity: 0.7;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 0.7em;
            opacity: 0.9;
        }

        .info-value {
            font-size: 1.3em;
        }

        #gameCanvas {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8C8 100%);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: block;
            width: 100%;
            max-width: 800px;
            height: 400px;
            margin: 0 auto;
        }

        .controls {
            margin-top: 20px;
            color: white;
            font-size: 1em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .jump-btn {
            margin-top: 15px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            touch-action: manipulation;
        }

        .jump-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .game-over-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 400px;
        }

        .modal-content h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content p {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #666;
        }

        .restart-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stage-clear-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .stage-clear-modal.show {
            display: flex;
        }

        .stage-clear-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 400px;
            color: white;
        }

        .stage-clear-content h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .stage-clear-content p {
            font-size: 1.3em;
            margin-bottom: 30px;
        }

        .next-stage-btn {
            padding: 15px 40px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .next-stage-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.4);
        }

        .start-screen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .start-screen-modal.hidden {
            display: none;
        }

        .start-screen-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 500px;
            color: white;
        }

        .start-screen-content h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .start-screen-content p {
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .start-btn {
            padding: 20px 60px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 30px;
            font-size: 1.5em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .start-btn:active {
            transform: translateY(-1px);
        }

        .last-update {
            margin-top: 30px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }

            .game-info {
                font-size: 1em;
            }

            #gameCanvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <a href="index.html" class="back-link">‚Üê ÁéÑÈñ¢„Å´Êàª„Çã</a>
        <h1>üèÉ „É©„É≥„Éã„É≥„Ç∞„Ç≤„Éº„É†</h1>
        
        <div class="game-info">
            <div class="info-item">
                <div class="info-label">„Çπ„ÉÜ„Éº„Ç∏</div>
                <div class="info-value" id="stageDisplay">1</div>
            </div>
            <div class="info-item">
                <div class="info-label">ÊÆã„ÇäË∑ùÈõ¢</div>
                <div class="info-value" id="distanceDisplay">0</div>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div class="controls">
            <p>„Çπ„Éö„Éº„Çπ„Ç≠„Éº„Åæ„Åü„ÅØ„Éú„Çø„É≥„Åß„Ç∏„É£„É≥„Éó</p>
            <button class="jump-btn" id="jumpBtn">„Ç∏„É£„É≥„ÉóÔºÅ</button>
        </div>
    </div>

    <div class="game-over-modal" id="gameOverModal">
        <div class="modal-content">
            <h2>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h2>
            <p>ÈöúÂÆ≥Áâ©„Å´ÂΩì„Åü„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü</p>
            <button class="restart-btn" onclick="restartStage()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶</button>
        </div>
    </div>

    <div class="stage-clear-modal" id="stageClearModal">
        <div class="stage-clear-content">
            <h2>üéâ „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ</h2>
            <p id="stageClearMessage">„Çπ„ÉÜ„Éº„Ç∏1„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ</p>
            <button class="next-stage-btn" onclick="nextStage()">Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏</button>
        </div>
    </div>

    <div class="start-screen-modal" id="startScreenModal">
        <div class="start-screen-content">
            <h2>üèÉ „É©„É≥„Éã„É≥„Ç∞„Ç≤„Éº„É†</h2>
            <p>„Ç∏„É£„É≥„Éó„ÅßÈöúÂÆ≥Áâ©„ÇíÈÅø„Åë„Å¶„Ç¥„Éº„É´„ÇíÁõÆÊåá„Åù„ÅÜÔºÅ</p>
            <button class="start-btn" onclick="hideStartScreen()">„Ç≤„Éº„É†ÈñãÂßã</button>
            <div class="last-update" id="lastUpdate"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // „Ç≠„É£„É≥„Éê„Çπ„ÅÆ„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
        function resizeCanvas() {
            const maxWidth = 800;
            const maxHeight = 400;
            const aspectRatio = maxWidth / maxHeight;
            
            let width = Math.min(window.innerWidth - 40, maxWidth);
            let height = width / aspectRatio;
            
            if (height > maxHeight) {
                height = maxHeight;
                width = height * aspectRatio;
            }
            
            canvas.width = width;
            canvas.height = height;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let currentStage = 1;
        let gameRunning = false;
        let gamePaused = false;

        // „Ç≠„É£„É©„ÇØ„Çø„Éº
        const player = {
            x: 100,
            y: 0,
            width: 40,
            height: 50,
            velocityY: 0,
            isJumping: false,
            groundY: 0,
            color: '#ff6b6b'
        };

        // Âú∞Èù¢„ÅÆÈ´ò„Åï
        const groundHeight = 50;
        player.groundY = canvas.height - groundHeight - player.height;
        player.y = player.groundY;

        // „Ç´„É°„É©Ôºà„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆÔºâ
        let cameraX = 0;
        const scrollSpeed = 2.2;

        // ÈöúÂÆ≥Áâ©„Å®ËêΩ„Å®„ÅóÁ©¥
        let obstacles = [];
        let pits = [];
        let goalX = 0;

        // „Çπ„ÉÜ„Éº„Ç∏„Éá„Éº„ÇøÔºàÈñìÈöî„ÇíÂÄç„Å´„ÄÅ„Ç≥„Éº„Çπ„ÇÇÂÄç„Å´Ôºâ
        const stages = [
            {
                obstacles: [
                    { x: 1000, width: 60, height: 80, type: 'box' },
                    { x: 1600, width: 60, height: 100, type: 'box' },
                    { x: 2400, width: 60, height: 60, type: 'triangle' }
                ],
                pits: [
                    { x: 1300, width: 100 },
                    { x: 1900, width: 80 }
                ],
                goal: 3000
            },
            {
                obstacles: [
                    { x: 800, width: 60, height: 90, type: 'box' },
                    { x: 1400, width: 60, height: 110, type: 'triangle' },
                    { x: 2000, width: 60, height: 70, type: 'box' },
                    { x: 2600, width: 60, height: 100, type: 'triangle' }
                ],
                pits: [
                    { x: 1100, width: 120 },
                    { x: 1700, width: 100 },
                    { x: 2300, width: 90 }
                ],
                goal: 3200
            },
            {
                obstacles: [
                    { x: 700, width: 60, height: 100, type: 'box' },
                    { x: 1200, width: 60, height: 120, type: 'triangle' },
                    { x: 1700, width: 60, height: 80, type: 'box' },
                    { x: 2200, width: 60, height: 110, type: 'triangle' },
                    { x: 2700, width: 60, height: 95, type: 'box' }
                ],
                pits: [
                    { x: 1000, width: 80 },
                    { x: 1500, width: 100 },
                    { x: 2000, width: 90 },
                    { x: 2500, width: 110 }
                ],
                goal: 3400
            }
        ];

        // Áâ©ÁêÜÂÆöÊï∞
        const gravity = 0.28; // „Çà„Çä„Éï„ÉØ„ÉÉ„Å®ÊµÆÈÅäÊÑü„ÇíÂá∫„Åô„Åü„ÇÅ„Å´‰∏ã„Åí„Çã
        const jumpPower = -16;
        const groundFriction = 0.9;
        const maxJumpHeight = 220; // ÊúÄÂ§ß„Ç∏„É£„É≥„ÉóÈ´ò„ÅïÔºàÁîªÈù¢„Åã„Çâ„ÅØ„ÅøÂá∫„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ

        // „Çπ„ÉÜ„Éº„Ç∏„ÇíË™≠„ÅøËæº„ÇÄ
        function loadStage(stageNumber) {
            const stage = stages[stageNumber - 1];
            obstacles = stage.obstacles.map(obs => ({
                ...obs,
                y: canvas.height - groundHeight - obs.height,
                type: obs.type || 'box' // „Éá„Éï„Ç©„É´„Éà„ÅØbox
            }));
            pits = stage.pits.map(pit => ({
                ...pit,
                y: canvas.height - groundHeight,
                depth: 200
            }));
            goalX = stage.goal;
            
            // „Éó„É¨„Ç§„É§„Éº„Çí„É™„Çª„ÉÉ„Éà
            player.x = 100;
            player.y = player.groundY;
            player.velocityY = 0;
            player.isJumping = false;
            cameraX = 0;
            
            updateDisplay();
        }

        // „Ç∏„É£„É≥„Éó
        function jump() {
            if (!player.isJumping && gameRunning && !gamePaused) {
                player.velocityY = jumpPower;
                player.isJumping = true;
            }
        }

        // „Éó„É¨„Ç§„É§„Éº„ÅåÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        // Ëá™„Ç≠„É£„É©„ÅÆÂè≥‰∏ãÔºàplayer.x + player.width, player.y + player.heightÔºâ„Åå
        // 1„Éî„ÇØ„Çª„É´„Åß„ÇÇÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´‰πó„Å£„Å¶„ÅÑ„Çå„Å∞true
        function isOnObstacle(obs) {
            const obsScreenX = obs.x - cameraX;
            
            // „Éó„É¨„Ç§„É§„Éº„ÅÆÂè≥‰∏ã„ÅÆÂ∫ßÊ®ô
            const playerRight = player.x + player.width;
            const playerBottom = player.y + player.height;
            
            // Âè≥‰∏ã„ÅåÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´‰πó„Å£„Å¶„ÅÑ„Çã„ÅãÔºà1„Éî„ÇØ„Çª„É´„Åß„ÇÇÔºâ
            // ÈöúÂÆ≥Áâ©„ÅÆ‰∏äÁ´ØÔºàobs.yÔºâ„Å´„Éó„É¨„Ç§„É§„Éº„ÅÆË∂≥„ÅåËß¶„Çå„Å¶„ÅÑ„Çã„Åã
            const isOnTop = playerBottom >= obs.y - 1 && playerBottom <= obs.y + 5;
            
            // Âè≥‰∏ã„ÅÆXÂ∫ßÊ®ô„ÅåÈöúÂÆ≥Áâ©„ÅÆÁØÑÂõ≤ÂÜÖ„Å´„ÅÇ„Çã„Åã
            const isInXRange = playerRight > obsScreenX && playerRight < obsScreenX + obs.width;
            
            // „Åæ„Åü„ÅØ„ÄÅ„Éó„É¨„Ç§„É§„Éº„ÅÆÂè≥Á´Ø„ÅåÈöúÂÆ≥Áâ©„ÅÆÂ∑¶Á´Ø„ÇíË∂Ö„Åà„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÇÇËÄÉÊÖÆ
            const isTouching = playerRight >= obsScreenX && player.x < obsScreenX + obs.width;
            
            return isTouching && isOnTop;
        }

        // Ë°ùÁ™ÅÂà§ÂÆö
        function checkCollisions() {
            // ÈöúÂÆ≥Áâ©„Å®„ÅÆË°ùÁ™Å
            for (let obs of obstacles) {
                const obsScreenX = obs.x - cameraX;
                
                // ÂõõËßí„ÅÆÈöúÂÆ≥Áâ©„ÅÆÂ†¥Âêà
                if (obs.type === 'box') {
                    // Ëá™„Ç≠„É£„É©„ÅÆÂè≥‰∏ã„Åå1„Éî„ÇØ„Çª„É´„Åß„ÇÇÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´‰πó„Å£„Å¶„ÅÑ„Çå„Å∞Ë°ùÁ™Å„Åó„Å™„ÅÑ
                    const playerRight = player.x + player.width;
                    const playerBottom = player.y + player.height;
                    
                    // Âè≥‰∏ã„ÅåÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´‰πó„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    const isRightBottomOnTop = playerRight >= obsScreenX && 
                                              playerRight <= obsScreenX + obs.width &&
                                              playerBottom >= obs.y - 1 && 
                                              playerBottom <= obs.y + 5;
                    
                    // „Åæ„Åü„ÅØ„ÄÅisOnObstacleÈñ¢Êï∞„ÅßÂà§ÂÆö
                    if (isOnObstacle(obs) || isRightBottomOnTop) {
                        continue; // Ë°ùÁ™Å„Åó„Å™„ÅÑ
                    }
                    
                    // ÂõõËßí„ÅÆÈöúÂÆ≥Áâ©„ÅÆÂÅ¥Èù¢„Éª‰∏ã„Åã„Çâ„ÅÆË°ùÁ™Å„ÅÆ„ÅøÂà§ÂÆö
                    const playerBottomY = player.y + player.height;
                    const playerTopY = player.y;
                    const obsTopY = obs.y;
                    const obsBottomY = obs.y + obs.height;
                    
                    // ÂÅ¥Èù¢„Åã„Çâ„ÅÆË°ùÁ™ÅÔºàÂ∑¶Âè≥Ôºâ- „Åü„Å†„Åó„ÄÅ‰∏ä„Å´‰πó„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈô§Â§ñ
                    const isOnLeftSide = player.x + player.width > obsScreenX && 
                                        player.x + player.width < obsScreenX + 15 &&
                                        playerTopY < obsBottomY && 
                                        playerBottomY > obsTopY &&
                                        !isRightBottomOnTop;
                    
                    const isOnRightSide = player.x < obsScreenX + obs.width && 
                                         player.x > obsScreenX + obs.width - 15 &&
                                         playerTopY < obsBottomY && 
                                         playerBottomY > obsTopY &&
                                         !isRightBottomOnTop;
                    
                    if (isOnLeftSide || isOnRightSide) {
                        return true;
                    }
                    
                    // ‰∏ã„Åã„Çâ„ÅÆË°ùÁ™ÅÔºà„Éó„É¨„Ç§„É§„Éº„ÅåÈöúÂÆ≥Áâ©„ÅÆ‰∏ã„Å´„ÅÑ„Å¶„ÄÅ‰∏ä„Å´Ë°ùÁ™ÅÔºâ
                    // „Åü„Å†„Åó„ÄÅÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´‰πó„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈô§Â§ñ
                    if (playerBottomY > obsTopY && 
                        playerTopY < obsTopY &&
                        player.x + player.width > obsScreenX + 5 &&
                        player.x < obsScreenX + obs.width - 5 &&
                        !isRightBottomOnTop) {
                        return true;
                    }
                } else if (obs.type === 'triangle') {
                    // ‰∏âËßí„ÅÆÈöúÂÆ≥Áâ©„ÅØ‰∏ä„Åã„ÇâË∏è„Çì„Åß„ÇÇÊ≠ª„Å¨Ôºà„Å©„ÅÆÊñπÂêë„Åã„Çâ„Åß„ÇÇË°ùÁ™ÅÔºâ
                    const topY = obs.y;
                    const bottomY = obs.y + obs.height;
                    const leftX = obsScreenX;
                    const rightX = obsScreenX + obs.width;
                    
                    // „Éó„É¨„Ç§„É§„Éº„Åå‰∏âËßí„ÅÆÁØÑÂõ≤ÂÜÖ„Å´„ÅÑ„Çã„Åã
                    if (player.x < rightX && player.x + player.width > leftX &&
                        player.y < bottomY && player.y + player.height > topY) {
                        // ‰∏âËßí„ÅÆÂÜÖÈÉ®Âà§ÂÆöÔºàÁ∞°ÊòìÁâàÔºö„Éó„É¨„Ç§„É§„Éº„ÅÆ‰∏≠ÂøÉÁÇπ„Åå‰∏âËßí„ÅÆÂÜÖÈÉ®„Å´„ÅÇ„Çã„ÅãÔºâ
                        const playerCenterX = player.x + player.width / 2;
                        const playerCenterY = player.y + player.height / 2;
                        
                        // ‰∏âËßí„ÅÆÂ∑¶ÂÅ¥„ÅÆÁ∑ö: y = topY + (bottomY - topY) * (x - leftX) / (width/2)
                        // ‰∏âËßí„ÅÆÂè≥ÂÅ¥„ÅÆÁ∑ö: y = topY + (bottomY - topY) * (rightX - x) / (width/2)
                        const centerX = obsScreenX + obs.width / 2;
                        const leftLineY = topY + (bottomY - topY) * (playerCenterX - leftX) / (obs.width / 2);
                        const rightLineY = topY + (bottomY - topY) * (rightX - playerCenterX) / (obs.width / 2);
                        const minY = Math.min(leftLineY, rightLineY);
                        
                        // „Éó„É¨„Ç§„É§„Éº„ÅÆ‰∏≠ÂøÉ„Åå‰∏âËßí„ÅÆÂÜÖÈÉ®„Å´„ÅÇ„Çã„Åã
                        if (playerCenterY > minY && playerCenterY < bottomY) {
                            return true;
                        }
                    }
                }
            }

            // ËêΩ„Å®„ÅóÁ©¥„Å®„ÅÆË°ùÁ™ÅÔºà„Éó„É¨„Ç§„É§„Éº„ÅåËêΩ„Å®„ÅóÁ©¥„ÅÆ‰∏ä„Å´„ÅÑ„Å¶„ÄÅÂú∞Èù¢„Çà„Çä‰∏ã„Å´ËêΩ„Å°„ÅüÂ†¥ÂêàÔºâ
            // „Åü„Å†„Åó„ÄÅËá™„Ç≠„É£„É©„Åå1„Éî„ÇØ„Çª„É´„Åß„ÇÇÂú∞Èù¢„Å®Êé•Ëß¶„Åó„Å¶„ÅÑ„Çå„Å∞Ê≠ª„Å™„Å™„ÅÑ
            for (let pit of pits) {
                const pitScreenX = pit.x - cameraX;
                // „Éó„É¨„Ç§„É§„Éº„ÅåËêΩ„Å®„ÅóÁ©¥„ÅÆÁØÑÂõ≤ÂÜÖ„Å´„ÅÑ„Çã
                if (player.x + player.width > pitScreenX &&
                    player.x < pitScreenX + pit.width) {
                    // „Éó„É¨„Ç§„É§„Éº„ÅÆË∂≥Ôºàplayer.y + player.heightÔºâ„ÅåÂú∞Èù¢Ôºàpit.yÔºâ„Çà„Çä‰∏ã„Å´ËêΩ„Å°„ÅüÂ†¥Âêà
                    // „Åü„Å†„Åó„ÄÅ1„Éî„ÇØ„Çª„É´„Åß„ÇÇÂú∞Èù¢„Å®Êé•Ëß¶„Åó„Å¶„ÅÑ„Çå„Å∞Ôºàplayer.y + player.height <= pit.y + 1ÔºâÊ≠ª„Å™„Å™„ÅÑ
                    const playerBottom = player.y + player.height;
                    const groundLevel = pit.y;
                    
                    // ÂÆåÂÖ®„Å´Âú∞Èù¢„Çà„Çä‰∏ã„Å´ËêΩ„Å°„ÅüÂ†¥Âêà„ÅÆ„ÅøÊ≠ª„Å¨Ôºà1„Éî„ÇØ„Çª„É´„ÅÆ‰ΩôË£ï„ÇíÊåÅ„Åü„Åõ„ÇãÔºâ
                    if (playerBottom > groundLevel + 1) {
                        return true;
                    }
                }
            }

            return false;
        }

        // „Ç¥„Éº„É´Âà§ÂÆö
        function checkGoal() {
            const goalScreenX = goalX - cameraX;
            return player.x >= goalScreenX - 50;
        }

        // Êõ¥Êñ∞Ë°®Á§∫
        function updateDisplay() {
            document.getElementById('stageDisplay').textContent = currentStage;
            const remainingDistance = Math.max(0, Math.floor((goalX - cameraX - player.x) / 10));
            document.getElementById('distanceDisplay').textContent = remainingDistance;
        }

        // „Ç≤„Éº„É†„É´„Éº„Éó
        function gameLoop() {
            if (!gameRunning || gamePaused) return;

            // „Ç´„É°„É©„Çí„Çπ„ÇØ„É≠„Éº„É´
            cameraX += scrollSpeed;

            // „Éó„É¨„Ç§„É§„Éº„ÅÆÁâ©ÁêÜ
            player.velocityY += gravity;
            player.y += player.velocityY;

            // ÊúÄÂ§ß„Ç∏„É£„É≥„ÉóÈ´ò„Åï„ÅÆÂà∂ÈôêÔºàÁîªÈù¢„Åã„Çâ„ÅØ„ÅøÂá∫„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
            const minY = player.groundY - maxJumpHeight;
            if (player.y < minY) {
                player.y = minY;
                player.velocityY = 0;
            }

            // ËêΩ„Å®„ÅóÁ©¥„ÅÆ‰∏ä„Å´„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            let onPit = false;
            for (let pit of pits) {
                const pitScreenX = pit.x - cameraX;
                if (player.x + player.width > pitScreenX &&
                    player.x < pitScreenX + pit.width) {
                    onPit = true;
                    break;
                }
            }

            // ÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´‰πó„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            let onObstacle = false;
            let obstacleTop = player.groundY;
            
            for (let obs of obstacles) {
                if (obs.type === 'box') {
                    const obsScreenX = obs.x - cameraX;
                    const playerRight = player.x + player.width;
                    const playerBottom = player.y + player.height;
                    
                    // Âè≥‰∏ã„ÅåÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´‰πó„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà1„Éî„ÇØ„Çª„É´„Åß„ÇÇÔºâ
                    const isRightBottomOnTop = playerRight >= obsScreenX && 
                                              playerRight <= obsScreenX + obs.width &&
                                              playerBottom >= obs.y - 1 && 
                                              playerBottom <= obs.y + 5;
                    
                    // „Åæ„Åü„ÅØ„ÄÅisOnObstacleÈñ¢Êï∞„ÅßÂà§ÂÆö
                    if (isOnObstacle(obs) || isRightBottomOnTop) {
                        obstacleTop = obs.y;
                        onObstacle = true;
                        // „Éó„É¨„Ç§„É§„Éº„ÇíÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´ÈÖçÁΩÆ
                        if (player.y + player.height > obs.y && player.velocityY >= 0) {
                            player.y = obs.y - player.height;
                            player.velocityY = 0;
                            player.isJumping = false;
                        }
                        break;
                    }
                }
            }

            // Âú∞Èù¢„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆöÔºàËêΩ„Å®„ÅóÁ©¥„ÅÆ‰∏ä„Å´„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (!onPit && !onObstacle && player.y >= player.groundY) {
                player.y = player.groundY;
                player.velocityY = 0;
                player.isJumping = false;
            }

            // Ë°ùÁ™ÅÂà§ÂÆö
            if (checkCollisions()) {
                gameOver();
                return;
            }

            // „Ç¥„Éº„É´Âà§ÂÆö
            if (checkGoal()) {
                stageClear();
                return;
            }

            // ÊèèÁîª
            draw();

            // Ë°®Á§∫Êõ¥Êñ∞
            updateDisplay();

            requestAnimationFrame(gameLoop);
        }

        // ÊèèÁîª
        function draw() {
            // ËÉåÊôØ„Çí„ÇØ„É™„Ç¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ËÉåÊôØÔºàÁ©∫Ôºâ
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#98D8C8');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Âú∞Èù¢
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);
            
            // Âú∞Èù¢„ÅÆ„ÉÜ„ÇØ„Çπ„ÉÅ„É£
            ctx.fillStyle = '#654321';
            for (let i = 0; i < canvas.width; i += 20) {
                ctx.fillRect(i - (cameraX % 20), canvas.height - groundHeight, 1, groundHeight);
            }

            // ËêΩ„Å®„ÅóÁ©¥„ÇíÊèèÁîª
            ctx.fillStyle = '#000000';
            for (let pit of pits) {
                const pitScreenX = pit.x - cameraX;
                if (pitScreenX > -pit.width && pitScreenX < canvas.width) {
                    ctx.fillRect(pitScreenX, pit.y, pit.width, pit.depth);
                }
            }

            // ÈöúÂÆ≥Áâ©„ÇíÊèèÁîª
            for (let obs of obstacles) {
                const obsScreenX = obs.x - cameraX;
                if (obsScreenX > -obs.width && obsScreenX < canvas.width) {
                    if (obs.type === 'triangle') {
                        // ‰∏âËßí„ÅÆÈöúÂÆ≥Áâ©„ÇíÊèèÁîª
                        ctx.fillStyle = '#ff4444';
                        ctx.beginPath();
                        ctx.moveTo(obsScreenX + obs.width / 2, obs.y); // È†ÇÁÇπ
                        ctx.lineTo(obsScreenX, obs.y + obs.height); // Â∑¶‰∏ã
                        ctx.lineTo(obsScreenX + obs.width, obs.y + obs.height); // Âè≥‰∏ã
                        ctx.closePath();
                        ctx.fill();
                        
                        // ‰∏âËßí„ÅÆÂΩ±
                        ctx.fillStyle = '#cc0000';
                        ctx.beginPath();
                        ctx.moveTo(obsScreenX + obs.width / 2 + 3, obs.y + 3);
                        ctx.lineTo(obsScreenX + 3, obs.y + obs.height + 3);
                        ctx.lineTo(obsScreenX + obs.width + 3, obs.y + obs.height + 3);
                        ctx.closePath();
                        ctx.fill();
                    } else {
                        // ÂõõËßí„ÅÆÈöúÂÆ≥Áâ©„ÇíÊèèÁîª
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(obsScreenX, obs.y, obs.width, obs.height);
                        
                        // ÈöúÂÆ≥Áâ©„ÅÆÂΩ±
                        ctx.fillStyle = '#654321';
                        ctx.fillRect(obsScreenX + 5, obs.y + obs.height, obs.width, 5);
                    }
                }
            }

            // „Ç¥„Éº„É´„ÇíÊèèÁîª
            const goalScreenX = goalX - cameraX;
            if (goalScreenX > -100 && goalScreenX < canvas.width + 100) {
                // „Ç¥„Éº„É´„Éï„É©„ÉÉ„Ç∞
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(goalScreenX - 5, canvas.height - groundHeight - 150, 10, 150);
                ctx.fillStyle = '#ffff00';
                ctx.beginPath();
                ctx.moveTo(goalScreenX - 5, canvas.height - groundHeight - 150);
                ctx.lineTo(goalScreenX - 5, canvas.height - groundHeight - 100);
                ctx.lineTo(goalScreenX + 30, canvas.height - groundHeight - 125);
                ctx.closePath();
                ctx.fill();
            }

            // „Éó„É¨„Ç§„É§„Éº„ÇíÊèèÁîª
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // „Éó„É¨„Ç§„É§„Éº„ÅÆÁõÆ
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(player.x + 10, player.y + 15, 8, 8);
            ctx.fillRect(player.x + 22, player.y + 15, 8, 8);
            ctx.fillStyle = '#000000';
            ctx.fillRect(player.x + 12, player.y + 17, 4, 4);
            ctx.fillRect(player.x + 24, player.y + 17, 4, 4);

            // Èõ≤„ÇíÊèèÁîªÔºàË£ÖÈ£æÔºâ
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 3; i++) {
                const cloudX = (i * 400 - (cameraX * 0.3) % 1200) % canvas.width;
                ctx.beginPath();
                ctx.arc(cloudX, 50, 20, 0, Math.PI * 2);
                ctx.arc(cloudX + 25, 50, 25, 0, Math.PI * 2);
                ctx.arc(cloudX + 50, 50, 20, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
        function gameOver() {
            gameRunning = false;
            gamePaused = true;
            document.getElementById('gameOverModal').classList.add('show');
        }

        // „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢
        function stageClear() {
            gameRunning = false;
            gamePaused = true;
            
            if (currentStage < 3) {
                document.getElementById('stageClearMessage').textContent = 
                    `„Çπ„ÉÜ„Éº„Ç∏${currentStage}„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ`;
                document.getElementById('stageClearModal').classList.add('show');
            } else {
                // ÂÖ®„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢
                document.getElementById('stageClearMessage').textContent = 
                    'ÂÖ®„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ';
                document.getElementById('stageClearModal').classList.add('show');
            }
        }

        // Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏
        function nextStage() {
            if (currentStage < 3) {
                currentStage++;
                document.getElementById('stageClearModal').classList.remove('show');
                loadStage(currentStage);
                startGame();
            } else {
                // „Ç≤„Éº„É†„ÇØ„É™„Ç¢
                document.getElementById('stageClearModal').classList.remove('show');
                restartGame();
            }
        }

        // „Çπ„ÉÜ„Éº„Ç∏„ÇíÂÜç„Çπ„Çø„Éº„Éà
        function restartStage() {
            document.getElementById('gameOverModal').classList.remove('show');
            loadStage(currentStage);
            startGame();
        }

        // „Ç≤„Éº„É†„ÇíÂÜçÈñã
        function restartGame() {
            currentStage = 1;
            document.getElementById('gameOverModal').classList.remove('show');
            document.getElementById('stageClearModal').classList.remove('show');
            loadStage(currentStage);
            startGame();
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            gameRunning = true;
            gamePaused = false;
            gameLoop();
        }

        // „Çπ„Çø„Éº„ÉàÁîªÈù¢„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
        function hideStartScreen() {
            document.getElementById('startScreenModal').classList.add('hidden');
            loadStage(1);
            startGame();
        }

        // ÊúÄÁµÇÊõ¥Êñ∞Êó•ÊôÇ„ÇíË°®Á§∫
        function updateLastUpdateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const dateStr = `${year}Âπ¥${month}Êúà${day}Êó• ${hours}:${minutes}`;
            document.getElementById('lastUpdate').textContent = `ÊúÄÁµÇÊõ¥Êñ∞: ${dateStr}`;
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (!document.getElementById('startScreenModal').classList.contains('hidden')) {
                    hideStartScreen();
                } else {
                    jump();
                }
            }
        });

        document.getElementById('jumpBtn').addEventListener('click', jump);
        document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            jump();
        });

        // ÂàùÊúüÂåñ
        updateLastUpdateTime();
        // „Ç≤„Éº„É†„ÅØËá™ÂãïÈñãÂßã„Åó„Å™„ÅÑÔºà„Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÇíÂæÖ„Å§Ôºâ
    </script>
</body>
</html>

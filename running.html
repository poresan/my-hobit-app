<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="è‡ªå‹•ã§èµ°ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚¸ãƒ£ãƒ³ãƒ—ã§æ“ä½œã™ã‚‹ã‚²ãƒ¼ãƒ ">
    <meta name="theme-color" content="#4a90e2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚²ãƒ¼ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2d3561 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            text-align: center;
            position: relative;
            z-index: 1;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 400;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1em;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-link:hover {
            opacity: 1;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: white;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
            font-weight: 300;
            letter-spacing: -0.5px;
            animation: titleFloat 3s ease-in-out infinite;
        }

        @keyframes titleFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            color: white;
            font-size: 1.2em;
            font-weight: 500;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 0.7em;
            opacity: 0.9;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: transform 0.3s ease;
        }

        .info-value:hover {
            transform: scale(1.1);
        }

        #gameCanvas {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            background: linear-gradient(to bottom, #1e3a5f 0%, #2d5a7f 50%, #4a7ba7 100%);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset,
                0 1px 0 rgba(255, 255, 255, 0.1) inset;
            display: block;
            width: 100%;
            max-width: 800px;
            height: 400px;
            margin: 0 auto;
            backdrop-filter: blur(10px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #gameCanvas:hover {
            transform: scale(1.01);
        }

        .controls {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1em;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            font-weight: 300;
        }

        .jump-btn {
            margin-top: 15px;
            padding: 16px 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 8px 24px rgba(102, 126, 234, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .jump-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .jump-btn:active::before {
            width: 300px;
            height: 300px;
        }

        .jump-btn:active {
            transform: scale(0.96);
            box-shadow: 
                0 4px 12px rgba(102, 126, 234, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }

        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .game-over-modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            max-width: 90%;
            width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-content h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: white;
            font-weight: 300;
            letter-spacing: -0.5px;
        }

        .modal-content p {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.7);
        }

        .restart-btn {
            padding: 16px 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 20px;
            box-shadow: 
                0 8px 24px rgba(102, 126, 234, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            overflow: hidden;
        }

        .restart-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .restart-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 32px rgba(102, 126, 234, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }

        .stage-clear-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .stage-clear-modal.show {
            display: flex;
        }

        .stage-clear-content {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            max-width: 90%;
            width: 400px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stage-clear-content h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .stage-clear-content p {
            font-size: 1.3em;
            margin-bottom: 30px;
        }

        .next-stage-btn {
            padding: 16px 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 8px 24px rgba(102, 126, 234, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            overflow: hidden;
        }

        .next-stage-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .next-stage-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .next-stage-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 32px rgba(102, 126, 234, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }

        .start-section {
            margin-bottom: 20px;
            text-align: center;
        }

        .start-btn {
            padding: 16px 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 8px 24px rgba(102, 126, 234, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            overflow: hidden;
        }

        .start-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .start-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 32px rgba(102, 126, 234, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }

        .start-btn:active {
            transform: translateY(0);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
        }

        .start-btn:active {
            transform: translateY(0);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .last-update {
            margin-top: 10px;
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }

            .game-info {
                font-size: 1em;
            }

            #gameCanvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <a href="index.html" class="back-link">â† ç„é–¢ã«æˆ»ã‚‹</a>
        <h1>ğŸƒ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚²ãƒ¼ãƒ </h1>
        
        <div class="start-section">
            <button class="start-btn" id="startBtn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            <div class="last-update" id="lastUpdate"></div>
            <div id="errorMessage" style="display: none; color: #ff6b6b; margin-top: 10px; padding: 10px; background: rgba(255, 107, 107, 0.1); border-radius: 8px; font-size: 0.9em;"></div>
        </div>

        <div class="game-info">
            <div class="info-item">
                <div class="info-label">ã‚¹ãƒ†ãƒ¼ã‚¸</div>
                <div class="info-value" id="stageDisplay">1</div>
            </div>
            <div class="info-item">
                <div class="info-label">æ®‹ã‚Šè·é›¢</div>
                <div class="info-value" id="distanceDisplay">0</div>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div class="controls">
            <p>ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã¾ãŸã¯ãƒœã‚¿ãƒ³ã§ã‚¸ãƒ£ãƒ³ãƒ—</p>
            <button class="jump-btn" id="jumpBtn">ã‚¸ãƒ£ãƒ³ãƒ—ï¼</button>
        </div>
    </div>

    <div class="game-over-modal" id="gameOverModal">
        <div class="modal-content">
            <h2>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h2>
            <p>éšœå®³ç‰©ã«å½“ãŸã£ã¦ã—ã¾ã„ã¾ã—ãŸ</p>
            <button class="restart-btn" onclick="restartStage()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
        </div>
    </div>

    <div class="stage-clear-modal" id="stageClearModal">
        <div class="stage-clear-content">
            <h2>ğŸ‰ ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼</h2>
            <p id="stageClearMessage">ã‚¹ãƒ†ãƒ¼ã‚¸1ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼</p>
            <button class="next-stage-btn" onclick="nextStage()">æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼šãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                        (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
        const isLowEndDevice = isMobile || (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4);
        
        // è»½é‡ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ/ãƒ¢ãƒã‚¤ãƒ«ã§ã¯é‡ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼‰
        const useLightweightMode = isLowEndDevice;
        
        // Canvasæç”»ã®æœ€é©åŒ–ï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç”»åƒã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
        if (useLightweightMode) {
            ctx.imageSmoothingEnabled = false;
        }
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
        function resizeCanvas() {
            const maxWidth = 800;
            const maxHeight = 400;
            const aspectRatio = maxWidth / maxHeight;
            
            let width = Math.min(window.innerWidth - 40, maxWidth);
            let height = width / aspectRatio;
            
            if (height > maxHeight) {
                height = maxHeight;
                width = height * aspectRatio;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // åœ°é¢ã®ä½ç½®ã‚’å†è¨ˆç®—ï¼ˆplayerãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
            if (typeof player !== 'undefined' && player) {
                updatePlayerGroundPosition();
            }
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã¯30fpsã«åˆ¶é™ï¼‰
        let lastFrameTime = 0;
        const targetFPS = useLightweightMode ? 30 : 60;
        const frameInterval = 1000 / targetFPS;

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let currentStage = 1;
        let gameRunning = false;
        let gamePaused = false;

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
        const player = {
            x: 100,
            y: 0,
            width: 40,
            height: 50,
            velocityY: 0,
            isJumping: false,
            groundY: 0,
            color: '#ff6b6b'
        };

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”»åƒã®ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆè¨­å®š
        const playerSpriteSheet = new Image();
        let playerImageLoaded = false;
        const spriteFrameCount = 4; // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆã®ã‚³ãƒæ•°
        let spriteFrameWidth = 0; // 1ã‚³ãƒã®å¹…ï¼ˆèª­ã¿è¾¼ã¿å¾Œã«è¨ˆç®—ï¼‰
        
        // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆç”»åƒã‚’èª­ã¿è¾¼ã‚€
        playerSpriteSheet.src = 'shiba.png';
        
        playerSpriteSheet.onload = function() {
            playerImageLoaded = true;
            // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆã®1ã‚³ãƒã®å¹…ã‚’è¨ˆç®—ï¼ˆæ¨ªã«4ã‚³ãƒä¸¦ã‚“ã§ã„ã‚‹ï¼‰
            spriteFrameWidth = playerSpriteSheet.width / spriteFrameCount;
            
            // ç”»åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªãŒã‚‰ã€é«˜ã•ã‚’50pxã«åˆã‚ã›ã¦ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            const imageAspectRatio = spriteFrameWidth / playerSpriteSheet.height;
            player.height = 50; // å‰ã®å››è§’å½¢ã¨åŒã˜é«˜ã•
            player.width = player.height * imageAspectRatio;
            
            // åœ°é¢ã®ä½ç½®ã‚’å†è¨ˆç®—ï¼ˆè¶³ãŒåœ°é¢ã«ã¤ãã‚ˆã†ã«ï¼‰
            updatePlayerGroundPosition();
            
            console.log('ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', playerSpriteSheet.width + 'x' + playerSpriteSheet.height + 'px');
            console.log('1ã‚³ãƒã®ã‚µã‚¤ã‚º:', spriteFrameWidth + 'x' + playerSpriteSheet.height + 'px');
            console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µã‚¤ã‚ºã«èª¿æ•´:', player.width + 'x' + player.height + 'px');
        };
        
        playerSpriteSheet.onerror = function() {
            console.warn('ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: shiba.png');
            console.warn('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æç”»ã‚’ä½¿ç”¨ã—ã¾ã™');
            playerImageLoaded = false;
            // ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œãªã„å ´åˆã§ã‚‚ã€åˆæœŸå€¤ï¼ˆ40Ã—50ï¼‰ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚µã‚¤ã‚ºã¯æ—¢ã«åˆæœŸå€¤ï¼ˆ40Ã—50ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®ã¾ã¾ä½¿ç”¨
            updatePlayerGroundPosition();
        };
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
        let animationFrameIndex = 0;
        let animationCounter = 0;
        const animationSpeed = 8; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆé€Ÿåº¦ï¼ˆå°ã•ã„ã»ã©é€Ÿã„ã€å¤§ãã„ã»ã©é…ã„ï¼‰

        // åœ°é¢ã®é«˜ã•
        const groundHeight = 50;
        
        // åœ°é¢ã®ä½ç½®ã‚’å†è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆè¶³ãŒåœ°é¢ã«ã¤ãã‚ˆã†ã«ï¼‰
        function updatePlayerGroundPosition() {
            // playerã¨canvasãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (typeof player === 'undefined' || !player) return;
            if (!canvas || canvas.height <= 0) return;
            
            player.groundY = canvas.height - groundHeight - player.height;
            // ã‚¸ãƒ£ãƒ³ãƒ—ä¸­ã§ãªã„å ´åˆã¯åœ°é¢ã«é…ç½®
            if (!player.isJumping && player.velocityY === 0) {
                player.y = player.groundY;
            }
        }
        
        // åˆæœŸä½ç½®ã‚’è¨­å®š
        updatePlayerGroundPosition();

        // ã‚«ãƒ¡ãƒ©ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ï¼‰
        let cameraX = 0;
        let targetCameraX = 0;
        const scrollSpeed = 1.8; // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ä¸‹ã’ã‚‹


        // éšœå®³ç‰©ã¨è½ã¨ã—ç©´
        let obstacles = [];
        let pits = [];
        let goalX = 0;

        // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ï¼ˆé–“éš”ã‚’å€ã«ã€ã‚³ãƒ¼ã‚¹ã‚‚å€ã«ï¼‰
        const stages = [
            {
                obstacles: [
                    { x: 1000, width: 60, height: 80, type: 'box' },
                    { x: 1600, width: 60, height: 100, type: 'box' },
                    { x: 2400, width: 60, height: 60, type: 'triangle' }
                ],
                pits: [
                    { x: 1300, width: 100 },
                    { x: 1900, width: 80 }
                ],
                goal: 3000
            },
            {
                obstacles: [
                    { x: 800, width: 60, height: 90, type: 'box' },
                    { x: 1400, width: 60, height: 110, type: 'triangle' },
                    { x: 2000, width: 60, height: 70, type: 'box' },
                    { x: 2600, width: 60, height: 100, type: 'triangle' }
                ],
                pits: [
                    { x: 1100, width: 120 },
                    { x: 1700, width: 100 },
                    { x: 2300, width: 90 }
                ],
                goal: 3200
            },
            {
                obstacles: [
                    { x: 700, width: 60, height: 100, type: 'box' },
                    { x: 1200, width: 60, height: 120, type: 'triangle' },
                    { x: 1700, width: 60, height: 80, type: 'box' },
                    { x: 2200, width: 60, height: 110, type: 'triangle' },
                    { x: 2700, width: 60, height: 95, type: 'box' }
                ],
                pits: [
                    { x: 1000, width: 80 },
                    { x: 1500, width: 100 },
                    { x: 2000, width: 90 },
                    { x: 2500, width: 110 }
                ],
                goal: 3400
            }
        ];

        // ç‰©ç†å®šæ•°
        const gravity = 0.12; // ã‚¸ãƒ£ãƒ³ãƒ—ã®æ»ç©ºæ™‚é–“ã‚’é•·ãã™ã‚‹ãŸã‚ã«ã•ã‚‰ã«ä¸‹ã’ã‚‹
        const jumpPower = -10; // ä¸Šæ˜‡é€Ÿåº¦ã‚‚ã‚†ã£ãã‚Šã«
        const groundFriction = 0.9;
        const maxJumpHeight = 220; // æœ€å¤§ã‚¸ãƒ£ãƒ³ãƒ—é«˜ã•ï¼ˆç”»é¢ã‹ã‚‰ã¯ã¿å‡ºãªã„ã‚ˆã†ã«ï¼‰

        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆåŠ¹æœéŸ³ç”¨ï¼‰
        let audioContext = null;
        
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // ã‚¸ãƒ£ãƒ³ãƒ—åŠ¹æœéŸ³ã‚’å†ç”Ÿ
        function playJumpSound() {
            if (!audioContext) {
                initAudioContext();
            }
            
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 440; // A4
            oscillator.type = 'sine';

            // éŸ³é‡ã®ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ï¼ˆçŸ­ãè»½å¿«ãªéŸ³ï¼‰
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åŠ¹æœéŸ³ã‚’å†ç”Ÿ
        function playGameOverSound() {
            if (!audioContext) {
                initAudioContext();
            }
            
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 220; // A3ï¼ˆä½ã„éŸ³ï¼‰
            oscillator.type = 'sawtooth';

            // éŸ³é‡ã®ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ï¼ˆä¸‹é™ã™ã‚‹éŸ³ï¼‰
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.frequency.exponentialRampToValueAtTime(110, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€
        function loadStage(stageNumber) {
            try {
                if (!canvas || canvas.height === 0) {
                    console.error('CanvasãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                const stage = stages[stageNumber - 1];
                if (!stage) {
                    console.error('ã‚¹ãƒ†ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', stageNumber);
                    return;
                }
                
                obstacles = stage.obstacles.map(obs => ({
                    ...obs,
                    y: canvas.height - groundHeight - obs.height,
                    type: obs.type || 'box' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯box
                }));
                pits = stage.pits.map(pit => ({
                    ...pit,
                    y: canvas.height - groundHeight,
                    depth: 200
                }));
                goalX = stage.goal;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                player.x = 100;
                player.velocityY = 0;
                player.isJumping = false;
                cameraX = 0;
                targetCameraX = 0;
                
                // åœ°é¢ã®ä½ç½®ã‚’å†è¨ˆç®—ã—ã¦ã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é…ç½®
                updatePlayerGroundPosition();
                player.y = player.groundY;
                
                updateDisplay();
                console.log('ã‚¹ãƒ†ãƒ¼ã‚¸', stageNumber, 'ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
            } catch (error) {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                throw error;
            }
        }

        // ã‚¸ãƒ£ãƒ³ãƒ—
        function jump() {
            if (!player.isJumping && gameRunning && !gamePaused) {
                player.velocityY = jumpPower;
                player.isJumping = true;
                playJumpSound(); // ã‚¸ãƒ£ãƒ³ãƒ—åŠ¹æœéŸ³
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒéšœå®³ç‰©ã®ä¸Šã«ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        // è‡ªã‚­ãƒ£ãƒ©ã®ä¸‹ã®éƒ¨åˆ†ï¼ˆè¶³ã®éƒ¨åˆ†ï¼‰ã®ã©ã“ã§ã‚‚éšœå®³ç‰©ã®ä¸Šã«ä¹—ã£ã¦ã„ã‚Œã°true
        function isOnObstacle(obs) {
            const obsScreenX = obs.x - cameraX;
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åº§æ¨™
            const playerLeft = player.x;
            const playerRight = player.x + player.width;
            const playerBottom = player.y + player.height;
            const playerTop = player.y;
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒéšœå®³ç‰©ã®Xç¯„å›²å†…ã«ã„ã‚‹ã‹ï¼ˆå°‘ã—ã§ã‚‚é‡ãªã£ã¦ã„ã‚Œã°OKï¼‰
            const isInXRange = playerRight > obsScreenX + 2 && 
                              playerLeft < obsScreenX + obs.width - 2;
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¶³ãŒéšœå®³ç‰©ã®ä¸Šç«¯ã«è§¦ã‚Œã¦ã„ã‚‹ã‹ï¼ˆã‚ˆã‚Šå¯›å®¹ã«ï¼‰
            // éšœå®³ç‰©ã®ä¸Šç«¯ï¼ˆobs.yï¼‰ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¶³ãŒè§¦ã‚Œã¦ã„ã‚‹ã‹
            const isOnTop = playerBottom >= obs.y - 3 && playerBottom <= obs.y + 10;
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒéšœå®³ç‰©ã®ä¸Šã«ã„ã‚‹ï¼ˆè½ä¸‹ä¸­ã¾ãŸã¯ç€åœ°æ™‚ï¼‰
            const isFallingOrLanded = player.velocityY >= -1;
            
            return isInXRange && isOnTop && isFallingOrLanded;
        }

        // è¡çªåˆ¤å®š
        function checkCollisions() {
            // éšœå®³ç‰©ã¨ã®è¡çª
            for (let obs of obstacles) {
                const obsScreenX = obs.x - cameraX;
                
                // å››è§’ã®éšœå®³ç‰©ã®å ´åˆ
                if (obs.type === 'box') {
                    // ä¸Šã‹ã‚‰è¸ã‚“ã§ã„ã‚‹å ´åˆã¯å®Œå…¨ã«ã‚¹ã‚­ãƒƒãƒ—ï¼ˆisOnObstacleé–¢æ•°ã§åˆ¤å®šï¼‰
                    if (isOnObstacle(obs)) {
                        continue; // è¡çªã—ãªã„
                    }
                    
                    // å››è§’ã®éšœå®³ç‰©ã®å´é¢ãƒ»ä¸‹ã‹ã‚‰ã®è¡çªã®ã¿åˆ¤å®š
                    const playerBottomY = player.y + player.height;
                    const playerTopY = player.y;
                    const playerLeft = player.x;
                    const playerRight = player.x + player.width;
                    const obsTopY = obs.y;
                    const obsBottomY = obs.y + obs.height;
                    const obsLeft = obsScreenX;
                    const obsRight = obsScreenX + obs.width;
                    
                    // éšœå®³ç‰©ã‹ã‚‰é™ã‚Šã‚‹æ™‚ï¼ˆéšœå®³ç‰©ã®å³ç«¯ã‚’è¶…ãˆãŸæ™‚ï¼‰ã¯æ­»ãªãªã„
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒéšœå®³ç‰©ã®å³ç«¯ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯ã€é™ã‚Šã¦ã„ã‚‹æœ€ä¸­ãªã®ã§è¡çªã—ãªã„
                    const isDescendingFromObstacle = playerLeft > obsRight - 5 && 
                                                     playerBottomY >= obsTopY - 5 && 
                                                     playerBottomY <= obsTopY + 10;
                    
                    // å´é¢ã‹ã‚‰ã®è¡çªï¼ˆå·¦å³ï¼‰- ãŸã ã—ã€ä¸Šã«ä¹—ã£ã¦ã„ã‚‹å ´åˆã‚„é™ã‚Šã¦ã„ã‚‹å ´åˆã¯é™¤å¤–
                    // å·¦å´ã‹ã‚‰ã®è¡çª
                    const isOnLeftSide = playerRight > obsLeft && 
                                        playerRight < obsLeft + 20 &&
                                        playerTopY < obsBottomY && 
                                        playerBottomY > obsTopY &&
                                        !isDescendingFromObstacle;
                    
                    // å³å´ã‹ã‚‰ã®è¡çªï¼ˆé™ã‚Šã¦ã„ã‚‹å ´åˆã¯é™¤å¤–ï¼‰
                    const isOnRightSide = playerLeft < obsRight && 
                                         playerLeft > obsRight - 20 &&
                                         playerTopY < obsBottomY && 
                                         playerBottomY > obsTopY &&
                                         !isDescendingFromObstacle;
                    
                    if (isOnLeftSide || isOnRightSide) {
                        return true;
                    }
                    
                    // ä¸‹ã‹ã‚‰ã®è¡çªï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒéšœå®³ç‰©ã®ä¸‹ã«ã„ã¦ã€ä¸Šã«è¡çªï¼‰
                    // ãŸã ã—ã€éšœå®³ç‰©ã®ä¸Šã«ä¹—ã£ã¦ã„ã‚‹å ´åˆã‚„é™ã‚Šã¦ã„ã‚‹å ´åˆã¯é™¤å¤–
                    if (playerBottomY > obsTopY && 
                        playerTopY < obsTopY &&
                        playerRight > obsLeft + 5 &&
                        playerLeft < obsRight - 5 &&
                        !isDescendingFromObstacle) {
                        return true;
                    }
                } else if (obs.type === 'triangle') {
                    // ä¸‰è§’ã®éšœå®³ç‰©ã¯ä¸‰è§’ã®éƒ¨åˆ†ã«è§¦ã‚ŒãŸã¨ãã®ã¿æ­»ã¬ï¼ˆã•ã‚‰ã«å°ã•ãªåˆ¤å®šï¼‰
                    const topY = obs.y;
                    const bottomY = obs.y + obs.height;
                    const leftX = obsScreenX;
                    const rightX = obsScreenX + obs.width;
                    const centerX = obsScreenX + obs.width / 2;
                    
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŸ©å½¢ã¨ä¸‰è§’ã®çŸ©å½¢ãŒé‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (player.x >= rightX || player.x + player.width <= leftX ||
                        player.y >= bottomY || player.y + player.height <= topY) {
                        // çŸ©å½¢ãŒé‡ãªã£ã¦ã„ãªã„å ´åˆã¯è¡çªã—ãªã„
                        continue;
                    }
                    
                    // å½“ãŸã‚Šåˆ¤å®šã‚’ã•ã‚‰ã«å°ã•ãã™ã‚‹ãŸã‚ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸­å¿ƒã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
                    // ã‚ˆã‚Šå³å¯†ã«ã€ä¸­å¿ƒç‚¹ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
                    const checkPoint = {
                        x: player.x + player.width / 2,
                        y: player.y + player.height / 2
                    };
                    
                    // ä¸­å¿ƒç‚¹ãŒä¸‰è§’ã®ç¯„å›²å†…ã«ã„ã‚‹ã‹
                    if (checkPoint.x >= leftX && checkPoint.x <= rightX &&
                        checkPoint.y >= topY && checkPoint.y <= bottomY) {
                        
                        // ä¸‰è§’ã®å·¦å´ã®ç·š: y = topY + (bottomY - topY) * (x - leftX) / (width/2)
                        // ä¸‰è§’ã®å³å´ã®ç·š: y = topY + (bottomY - topY) * (rightX - x) / (width/2)
                        let lineY;
                        
                        if (checkPoint.x <= centerX) {
                            // å·¦å´ã®ç·š
                            lineY = topY + (bottomY - topY) * (checkPoint.x - leftX) / (obs.width / 2);
                            // ãƒã‚¤ãƒ³ãƒˆãŒç·šã‚ˆã‚Šä¸‹ï¼ˆä¸‰è§’ã®å†…éƒ¨ï¼‰ã«ã‚ã‚‹ã‹ï¼ˆ15ãƒ”ã‚¯ã‚»ãƒ«ã®å¤§ããªä½™è£•ã§åˆ¤å®šã‚’å°ã•ãï¼‰
                            if (checkPoint.y >= lineY + 15) {
                                return true; // ä¸‰è§’ã®å†…éƒ¨ã«ã„ã‚‹
                            }
                        } else {
                            // å³å´ã®ç·š
                            lineY = topY + (bottomY - topY) * (rightX - checkPoint.x) / (obs.width / 2);
                            // ãƒã‚¤ãƒ³ãƒˆãŒç·šã‚ˆã‚Šä¸‹ï¼ˆä¸‰è§’ã®å†…éƒ¨ï¼‰ã«ã‚ã‚‹ã‹ï¼ˆ15ãƒ”ã‚¯ã‚»ãƒ«ã®å¤§ããªä½™è£•ã§åˆ¤å®šã‚’å°ã•ãï¼‰
                            if (checkPoint.y >= lineY + 15) {
                                return true; // ä¸‰è§’ã®å†…éƒ¨ã«ã„ã‚‹
                            }
                        }
                    }
                }
            }

            // è½ã¨ã—ç©´ã¨ã®è¡çªï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè½ã¨ã—ç©´ã®ä¸Šã«ã„ã¦ã€åœ°é¢ã‚ˆã‚Šä¸‹ã«è½ã¡ãŸå ´åˆï¼‰
            // ç€åœ°æ™‚ã«å°‘ã—ã§ã‚‚è§¦ã‚Œã¦ã„ã‚Œã°OK
            for (let pit of pits) {
                const pitScreenX = pit.x - cameraX;
                const groundLevel = pit.y;
                const playerBottom = player.y + player.height;
                const playerLeft = player.x;
                const playerRight = player.x + player.width;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè½ã¨ã—ç©´ã®ç¯„å›²ã¨é‡ãªã£ã¦ã„ã‚‹ã‹ï¼ˆå®Œå…¨ã«æ¸¡ã‚Šãã£ã¦ã„ãªã„å ´åˆã‚‚å«ã‚€ï¼‰
                const isOverlapping = playerRight > pitScreenX && playerLeft < pitScreenX + pit.width;
                
                if (isOverlapping) {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¶³ã®éƒ¨åˆ†ãŒè½ã¨ã—ç©´ã®ç¯„å›²å†…ã«ã‚ã‚‹éƒ¨åˆ†ã‚’ãƒã‚§ãƒƒã‚¯
                    const overlapLeft = Math.max(playerLeft, pitScreenX);
                    const overlapRight = Math.min(playerRight, pitScreenX + pit.width);
                    
                    // é‡ãªã£ã¦ã„ã‚‹éƒ¨åˆ†ã®è¶³ã®éƒ¨åˆ†ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆç€åœ°æ™‚ã‚’è€ƒæ…®ï¼‰
                    // è‡ªã‚­ãƒ£ãƒ©ã®ä¸€éƒ¨ã§ã‚‚ç€åœ°ã§ãã¦ã„ã‚Œã°æ­»ãªãªã„
                    const checkPoints = 50; // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’ã•ã‚‰ã«å¢—ã‚„ã™
                    let isTouchingGround = false;
                    
                    // é‡ãªã£ã¦ã„ã‚‹éƒ¨åˆ†ã®è¶³ã®éƒ¨åˆ†ã‚’å‡ç­‰ã«ãƒã‚§ãƒƒã‚¯
                    for (let i = 0; i <= checkPoints; i++) {
                        const ratio = i / checkPoints;
                        const checkX = overlapLeft + (overlapRight - overlapLeft) * ratio;
                        const checkY = playerBottom;
                        
                        // ã“ã®ãƒã‚¤ãƒ³ãƒˆãŒåœ°é¢ã«æ¥ã—ã¦ã„ã‚‹ã‹ï¼ˆ80ãƒ”ã‚¯ã‚»ãƒ«ã®å¤§ããªä½™è£•ã‚’æŒãŸã›ã‚‹ï¼‰
                        // è‡ªã‚­ãƒ£ãƒ©ã®ä¸€éƒ¨ã§ã‚‚ç€åœ°ã§ãã¦ã„ã‚Œã°OK
                        if (checkY <= groundLevel + 80) {
                            isTouchingGround = true;
                            break;
                        }
                    }
                    
                    // å®Œå…¨ã«åœ°é¢ã‚ˆã‚Šä¸‹ã«è½ã¡ãŸå ´åˆã®ã¿æ­»ã¬
                    // è‡ªã‚­ãƒ£ãƒ©ã®ä¸€éƒ¨ã§ã‚‚ç€åœ°ã§ãã¦ã„ã‚Œã°æ­»ãªãªã„
                    if (!isTouchingGround && playerBottom > groundLevel + 80) {
                        return true;
                    }
                }
            }

            return false;
        }

        // ã‚´ãƒ¼ãƒ«åˆ¤å®š
        function checkGoal() {
            const goalScreenX = goalX - cameraX;
            return player.x >= goalScreenX - 50;
        }

        // æ›´æ–°è¡¨ç¤º
        function updateDisplay() {
            document.getElementById('stageDisplay').textContent = currentStage;
            const remainingDistance = Math.max(0, Math.floor((goalX - cameraX - player.x) / 10));
            document.getElementById('distanceDisplay').textContent = remainingDistance;
        }

        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function gameLoop() {
            if (!gameRunning || gamePaused) return;

            // ã‚«ãƒ¡ãƒ©ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆæ»‘ã‚‰ã‹ãªè£œé–“ï¼‰
            targetCameraX += scrollSpeed;
            cameraX += (targetCameraX - cameraX) * 0.1; // æ»‘ã‚‰ã‹ãªè£œé–“
            
            // èµ°è¡Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°ï¼ˆåœ°é¢ã«ã„ã‚‹æ™‚ã®ã¿ï¼‰
            if (playerImageLoaded && spriteFrameWidth > 0 && !player.isJumping) {
                animationCounter++;
                if (animationCounter >= animationSpeed) {
                    animationCounter = 0;
                    animationFrameIndex = (animationFrameIndex + 1) % spriteFrameCount;
                }
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç‰©ç†ï¼ˆãµã‚“ã‚ã‚Šã—ãŸã‚¸ãƒ£ãƒ³ãƒ—ï¼‰
            // ã‚¸ãƒ£ãƒ³ãƒ—ã®é ‚ç‚¹ä»˜è¿‘ã§é‡åŠ›ã‚’å¼±ã‚ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šæ»‘ã‚‰ã‹ãªå‹•ãã«
            let currentGravity = gravity;
            
            // ä¸Šæ˜‡ä¸­ã¯é€šå¸¸ã®é‡åŠ›ã€é ‚ç‚¹ä»˜è¿‘ã§é‡åŠ›ã‚’å¼±ã‚ã€ä¸‹é™ä¸­ã¯æ®µéšçš„ã«é‡åŠ›ã‚’å¼·ã‚ã‚‹
            if (player.velocityY > 0) {
                // ä¸‹é™ä¸­ï¼šæ®µéšçš„ã«é‡åŠ›ã‚’å¼·ã‚ã‚‹ï¼ˆã‚ˆã‚Šè‡ªç„¶ãªå‹•ãï¼‰
                // ä¸‹é™é€Ÿåº¦ãŒé€Ÿã„ã»ã©é‡åŠ›ã‚’å¼·ã
                const fallSpeed = Math.min(player.velocityY, 5);
                currentGravity = gravity * (1 + fallSpeed * 0.1);
            } else if (player.velocityY > -3) {
                // é ‚ç‚¹ä»˜è¿‘ï¼šé‡åŠ›ã‚’å¤§å¹…ã«å¼±ã‚ã‚‹ï¼ˆãµã‚“ã‚ã‚Šæ„Ÿï¼‰
                const nearTop = (player.velocityY + 3) / 3; // 0 (é ‚ç‚¹) ã‹ã‚‰ 1 (å°‘ã—ä¸‹) ã¸ã®å€¤
                currentGravity = gravity * (0.3 + nearTop * 0.4); // 0.3å€ã‹ã‚‰0.7å€ã¾ã§
            } else {
                // ä¸Šæ˜‡ä¸­ï¼šé€šå¸¸ã®é‡åŠ›
                currentGravity = gravity;
            }
            
            player.velocityY += currentGravity;
            
            // æœ€å¤§ã‚¸ãƒ£ãƒ³ãƒ—é«˜ã•ã®åˆ¶é™ï¼ˆç”»é¢ã‹ã‚‰ã¯ã¿å‡ºãªã„ã‚ˆã†ã«ï¼‰
            // åˆ¶é™ã«è¿‘ã¥ã„ãŸã‚‰æ»‘ã‚‰ã‹ã«æ¸›é€Ÿã•ã›ã‚‹
            const minY = player.groundY - maxJumpHeight;
            const distanceToLimit = player.y - minY;
            
            if (distanceToLimit < 20 && player.velocityY < 0) {
                // åˆ¶é™ã«è¿‘ã¥ã„ãŸã‚‰ï¼ˆ20ãƒ”ã‚¯ã‚»ãƒ«ä»¥å†…ï¼‰ã€ä¸Šæ˜‡é€Ÿåº¦ã‚’æ»‘ã‚‰ã‹ã«æ¸›ã‚‰ã™
                const slowdownFactor = Math.max(0.3, distanceToLimit / 20);
                player.velocityY *= slowdownFactor;
            }
            
            player.y += player.velocityY;
            
            // æœ€çµ‚çš„ãªåˆ¶é™ï¼ˆå®Œå…¨ã«è¶…ãˆãŸå ´åˆã®ã¿å¼·åˆ¶çš„ã«æ­¢ã‚ã‚‹ï¼‰
            if (player.y < minY) {
                player.y = minY;
                // å®Œå…¨ã«æ­¢ã‚ã‚‹ã®ã§ã¯ãªãã€è‡ªç„¶ã«ä¸‹é™ã‚’é–‹å§‹
                if (player.velocityY < 0) {
                    player.velocityY = 0;
                }
            }

            // è½ã¨ã—ç©´ã®ä¸Šã«ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            let onPit = false;
            for (let pit of pits) {
                const pitScreenX = pit.x - cameraX;
                if (player.x + player.width > pitScreenX &&
                    player.x < pitScreenX + pit.width) {
                    onPit = true;
                    break;
                }
            }

            // éšœå®³ç‰©ã®ä¸Šã«ä¹—ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            let onObstacle = false;
            let obstacleTop = player.groundY;
            
            for (let obs of obstacles) {
                if (obs.type === 'box' && isOnObstacle(obs)) {
                    obstacleTop = obs.y;
                    onObstacle = true;
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’éšœå®³ç‰©ã®ä¸Šã«é…ç½®
                    if (player.y + player.height > obs.y && player.velocityY >= 0) {
                        player.y = obs.y - player.height;
                        player.velocityY = 0;
                        player.isJumping = false;
                    }
                    break;
                }
            }

            // åœ°é¢ã¨ã®è¡çªåˆ¤å®šï¼ˆè½ã¨ã—ç©´ã®ä¸Šã«ã„ãªã„å ´åˆã®ã¿ï¼‰
            if (!onPit && !onObstacle && player.y >= player.groundY) {
                player.y = player.groundY;
                player.velocityY = 0;
                player.isJumping = false;
            }

            // è¡çªåˆ¤å®š
            if (checkCollisions()) {
                gameOver();
                return;
            }

            // ã‚´ãƒ¼ãƒ«åˆ¤å®š
            if (checkGoal()) {
                stageClear();
                return;
            }

            // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã¯30fpsã«åˆ¶é™ï¼‰
            const currentTime = performance.now();
            const elapsed = currentTime - lastFrameTime;
            
            if (elapsed >= frameInterval) {
                lastFrameTime = currentTime - (elapsed % frameInterval);
                
                // æç”»
                draw();

                // è¡¨ç¤ºæ›´æ–°
                updateDisplay();
            }

            requestAnimationFrame(gameLoop);
        }

        // æç”»
        function draw() {
            // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // èƒŒæ™¯ï¼ˆç©ºï¼‰- Appleé¢¨ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1e3a5f');
            gradient.addColorStop(0.3, '#2d5a7f');
            gradient.addColorStop(0.6, '#4a7ba7');
            gradient.addColorStop(1, '#6b9bc7');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // èƒŒæ™¯ã®å…‰ã®åŠ¹æœï¼ˆå›ºå®šä½ç½®ï¼‰- è»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–
            if (!useLightweightMode) {
                const lightGradient = ctx.createRadialGradient(
                    canvas.width * 0.3, 
                    canvas.height * 0.3, 
                    0,
                    canvas.width * 0.3, 
                    canvas.height * 0.3, 
                    canvas.width * 0.8
                );
                lightGradient.addColorStop(0, 'rgba(102, 126, 234, 0.2)');
                lightGradient.addColorStop(1, 'rgba(102, 126, 234, 0)');
                ctx.fillStyle = lightGradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // åœ°é¢ - Appleé¢¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³
            const groundGradient = ctx.createLinearGradient(0, canvas.height - groundHeight, 0, canvas.height);
            groundGradient.addColorStop(0, '#3d2817');
            groundGradient.addColorStop(1, '#2d1f12');
            ctx.fillStyle = groundGradient;
            ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);
            
            // åœ°é¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–ï¼‰
            if (!useLightweightMode) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.fillRect(0, canvas.height - groundHeight, canvas.width, 2);
            }

            // è½ã¨ã—ç©´ã‚’æç”» - Appleé¢¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³
            for (let pit of pits) {
                const pitScreenX = pit.x - cameraX;
                if (pitScreenX > -pit.width && pitScreenX < canvas.width) {
                    // è½ã¨ã—ç©´ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    const pitGradient = ctx.createLinearGradient(
                        pitScreenX, pit.y,
                        pitScreenX, pit.y + pit.depth
                    );
                    pitGradient.addColorStop(0, '#1a1a1a');
                    pitGradient.addColorStop(0.5, '#0a0a0a');
                    pitGradient.addColorStop(1, '#000000');
                    
                    ctx.fillStyle = pitGradient;
                    ctx.fillRect(pitScreenX, pit.y, pit.width, pit.depth);
                    
                    // è½ã¨ã—ç©´ã®ç¸ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–ï¼‰
                    if (!useLightweightMode) {
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(pitScreenX, pit.y, pit.width, 2);
                    }
                }
            }

            // éšœå®³ç‰©ã‚’æç”» - Appleé¢¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³
            for (let obs of obstacles) {
                const obsScreenX = obs.x - cameraX;
                if (obsScreenX > -obs.width && obsScreenX < canvas.width) {
                    if (obs.type === 'triangle') {
                        // ä¸‰è§’ã®éšœå®³ç‰©ã‚’æç”»ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                        const triangleGradient = ctx.createLinearGradient(
                            obsScreenX, obs.y,
                            obsScreenX, obs.y + obs.height
                        );
                        triangleGradient.addColorStop(0, '#ff6b6b');
                        triangleGradient.addColorStop(1, '#ee5a6f');
                        
                        if (!useLightweightMode) {
                            ctx.shadowBlur = 20;
                            ctx.shadowColor = 'rgba(255, 107, 107, 0.5)';
                        }
                        ctx.fillStyle = triangleGradient;
                        ctx.beginPath();
                        ctx.moveTo(obsScreenX + obs.width / 2, obs.y);
                        ctx.lineTo(obsScreenX, obs.y + obs.height);
                        ctx.lineTo(obsScreenX + obs.width, obs.y + obs.height);
                        ctx.closePath();
                        ctx.fill();
                        ctx.shadowBlur = 0;
                        
                        // ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–ï¼‰
                        if (!useLightweightMode) {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                            ctx.beginPath();
                            ctx.moveTo(obsScreenX + obs.width / 2, obs.y);
                            ctx.lineTo(obsScreenX + obs.width * 0.3, obs.y + obs.height * 0.5);
                            ctx.lineTo(obsScreenX + obs.width * 0.2, obs.y + obs.height);
                            ctx.lineTo(obsScreenX, obs.y + obs.height);
                            ctx.closePath();
                            ctx.fill();
                        }
                    } else {
                        // å››è§’ã®éšœå®³ç‰©ã‚’æç”»ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                        const boxGradient = ctx.createLinearGradient(
                            obsScreenX, obs.y,
                            obsScreenX, obs.y + obs.height
                        );
                        boxGradient.addColorStop(0, '#8B6F47');
                        boxGradient.addColorStop(1, '#6B5432');
                        
                        if (!useLightweightMode) {
                            ctx.shadowBlur = 15;
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                        }
                        ctx.fillStyle = boxGradient;
                        ctx.fillRect(obsScreenX, obs.y, obs.width, obs.height);
                        ctx.shadowBlur = 0;
                        
                        // ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–ï¼‰
                        if (!useLightweightMode) {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                            ctx.fillRect(obsScreenX, obs.y, obs.width, obs.height * 0.3);
                            
                            // å½±
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                            ctx.fillRect(obsScreenX + 3, obs.y + obs.height, obs.width, 6);
                        }
                    }
                }
            }

            // ã‚´ãƒ¼ãƒ«ã‚’æç”» - Appleé¢¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³
            const goalScreenX = goalX - cameraX;
            if (goalScreenX > -100 && goalScreenX < canvas.width + 100) {
                // ã‚´ãƒ¼ãƒ«ã®å…‰ã®åŠ¹æœï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–ï¼‰
                if (!useLightweightMode) {
                    const goalGlow = ctx.createRadialGradient(
                        goalScreenX, canvas.height - groundHeight - 75,
                        0,
                        goalScreenX, canvas.height - groundHeight - 75,
                        100
                    );
                    goalGlow.addColorStop(0, 'rgba(76, 175, 80, 0.4)');
                    goalGlow.addColorStop(1, 'rgba(76, 175, 80, 0)');
                    ctx.fillStyle = goalGlow;
                    ctx.fillRect(goalScreenX - 100, 0, 200, canvas.height);
                }
                
                // ã‚´ãƒ¼ãƒ«ãƒ•ãƒ©ãƒƒã‚°ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                const flagGradient = ctx.createLinearGradient(
                    goalScreenX - 5, canvas.height - groundHeight - 150,
                    goalScreenX - 5, canvas.height - groundHeight
                );
                flagGradient.addColorStop(0, '#4CAF50');
                flagGradient.addColorStop(1, '#2E7D32');
                
                if (!useLightweightMode) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = 'rgba(76, 175, 80, 0.6)';
                }
                ctx.fillStyle = flagGradient;
                ctx.fillRect(goalScreenX - 5, canvas.height - groundHeight - 150, 10, 150);
                ctx.shadowBlur = 0;
                
                // ãƒ•ãƒ©ãƒƒã‚°ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–ï¼‰
                if (!useLightweightMode) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fillRect(goalScreenX - 5, canvas.height - groundHeight - 150, 10, 50);
                }
                
                // ãƒ•ãƒ©ãƒƒã‚°ã®å¸ƒéƒ¨åˆ†ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                const clothGradient = ctx.createLinearGradient(
                    goalScreenX - 5, canvas.height - groundHeight - 100,
                    goalScreenX + 30, canvas.height - groundHeight - 125
                );
                clothGradient.addColorStop(0, '#FFD700');
                clothGradient.addColorStop(1, '#FFA500');
                
                ctx.fillStyle = clothGradient;
                ctx.beginPath();
                ctx.moveTo(goalScreenX - 5, canvas.height - groundHeight - 150);
                ctx.lineTo(goalScreenX - 5, canvas.height - groundHeight - 100);
                ctx.lineTo(goalScreenX + 30, canvas.height - groundHeight - 125);
                ctx.closePath();
                ctx.fill();
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æç”»
            if (playerImageLoaded && spriteFrameWidth > 0) {
                // ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆã‹ã‚‰æç”»
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½±ï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–ï¼‰
                if (!useLightweightMode) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                    ctx.fillRect(player.x + 3, player.y + player.height + 2, player.width, 4);
                }
                
                // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆã‹ã‚‰ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’åˆ‡ã‚Šå‡ºã—ã¦æç”»
                // èµ°è¡Œä¸­ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¸ãƒ£ãƒ³ãƒ—ä¸­ã¯1ã‚³ãƒç›®ã‚’è¡¨ç¤º
                const currentFrame = player.isJumping ? 0 : animationFrameIndex;
                const sourceX = currentFrame * spriteFrameWidth;
                
                // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆã‹ã‚‰1ã‚³ãƒã‚’åˆ‡ã‚Šå‡ºã—ã¦æç”»
                ctx.drawImage(
                    playerSpriteSheet,
                    sourceX, 0,                    // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆä¸Šã®åˆ‡ã‚Šå‡ºã—ä½ç½®ï¼ˆx, yï¼‰
                    spriteFrameWidth, playerSpriteSheet.height, // åˆ‡ã‚Šå‡ºã™ã‚µã‚¤ã‚º
                    player.x, player.y,           // æç”»å…ˆã®ä½ç½®
                    player.width, player.height    // æç”»ã‚µã‚¤ã‚º
                );
                
                // ã‚¸ãƒ£ãƒ³ãƒ—æ™‚ã®ã‚°ãƒ­ãƒ¼åŠ¹æœï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç„¡åŠ¹åŒ–ï¼‰
                if (!useLightweightMode && player.isJumping && player.velocityY < 0) {
                    ctx.fillStyle = 'rgba(102, 126, 234, 0.3)';
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = 'rgba(102, 126, 234, 0.8)';
                    ctx.fillRect(player.x - 5, player.y - 5, player.width + 10, player.height + 10);
                    ctx.shadowBlur = 0;
                }
            } else {
                // ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æç”»ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½±ï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–ï¼‰
                if (!useLightweightMode) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                    ctx.fillRect(player.x + 3, player.y + player.height + 2, player.width, 4);
                }
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ¬ä½“ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                const playerGradient = ctx.createLinearGradient(
                    player.x, player.y, 
                    player.x, player.y + player.height
                );
                playerGradient.addColorStop(0, '#ff7a8a');
                playerGradient.addColorStop(1, '#ff6b6b');
                ctx.fillStyle = playerGradient;
                if (!useLightweightMode) {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = 'rgba(255, 107, 107, 0.5)';
                }
                ctx.fillRect(player.x, player.y, player.width, player.height);
                ctx.shadowBlur = 0;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç°¡ç•¥åŒ–ï¼‰
                if (!useLightweightMode) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fillRect(player.x, player.y, player.width, player.height * 0.3);
                }
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç›®
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(player.x + 10, player.y + 15, 8, 8);
                ctx.fillRect(player.x + 22, player.y + 15, 8, 8);
                ctx.fillStyle = '#000000';
                ctx.fillRect(player.x + 12, player.y + 17, 4, 4);
                ctx.fillRect(player.x + 24, player.y + 17, 4, 4);
                
                // ã‚¸ãƒ£ãƒ³ãƒ—æ™‚ã®ã‚°ãƒ­ãƒ¼åŠ¹æœï¼ˆè»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç„¡åŠ¹åŒ–ï¼‰
                if (!useLightweightMode && player.isJumping && player.velocityY < 0) {
                    ctx.fillStyle = 'rgba(102, 126, 234, 0.3)';
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = 'rgba(102, 126, 234, 0.8)';
                    ctx.fillRect(player.x - 5, player.y - 5, player.width + 10, player.height + 10);
                    ctx.shadowBlur = 0;
                }
            }

            // é›²ã‚’æç”»ï¼ˆè£…é£¾ï¼‰- Appleé¢¨ã®æ´—ç·´ã•ã‚ŒãŸé›²ï¼ˆå›ºå®šä½ç½®ï¼‰
            // è»½é‡ãƒ¢ãƒ¼ãƒ‰ã§ã¯é›²ã‚’æç”»ã—ãªã„ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
            if (!useLightweightMode) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
                for (let i = 0; i < 4; i++) {
                    const cloudX = (i * 400) % canvas.width;
                    const cloudY = 40 + Math.sin(i) * 10;
                    ctx.beginPath();
                    ctx.arc(cloudX, cloudY, 25, 0, Math.PI * 2);
                    ctx.arc(cloudX + 30, cloudY, 30, 0, Math.PI * 2);
                    ctx.arc(cloudX + 60, cloudY, 25, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
        function gameOver() {
            gameRunning = false;
            gamePaused = true;
            playGameOverSound(); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åŠ¹æœéŸ³
            
            document.getElementById('gameOverModal').classList.add('show');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
        function stageClear() {
            gameRunning = false;
            gamePaused = true;
            
            if (currentStage < 3) {
                document.getElementById('stageClearMessage').textContent = 
                    `ã‚¹ãƒ†ãƒ¼ã‚¸${currentStage}ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼`;
                document.getElementById('stageClearModal').classList.add('show');
            } else {
                // å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
                document.getElementById('stageClearMessage').textContent = 
                    'å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼';
                document.getElementById('stageClearModal').classList.add('show');
            }
        }

        // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸
        function nextStage() {
            if (currentStage < 3) {
                currentStage++;
                document.getElementById('stageClearModal').classList.remove('show');
                loadStage(currentStage);
                startGame();
            } else {
                // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢
                document.getElementById('stageClearModal').classList.remove('show');
                restartGame();
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å†ã‚¹ã‚¿ãƒ¼ãƒˆ
        function restartStage() {
            document.getElementById('gameOverModal').classList.remove('show');
            loadStage(currentStage);
            startGame();
        }

        // ã‚²ãƒ¼ãƒ ã‚’å†é–‹
        function restartGame() {
            currentStage = 1;
            document.getElementById('gameOverModal').classList.remove('show');
            document.getElementById('stageClearModal').classList.remove('show');
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.textContent = 'ã‚²ãƒ¼ãƒ é–‹å§‹';
            loadStage(currentStage);
            // ã‚²ãƒ¼ãƒ ã¯è‡ªå‹•é–‹å§‹ã—ãªã„
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            gameRunning = true;
            gamePaused = false;
            gameLoop();
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + message;
                errorDiv.style.display = 'block';
                console.error(message);
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        
        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
        function handleStart() {
            try {
                hideError();
                const startBtn = document.getElementById('startBtn');
                if (startBtn.disabled) return;
                
                startBtn.disabled = true;
                startBtn.textContent = 'ã‚²ãƒ¼ãƒ ä¸­...';
                
                console.log('ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™...');
                console.log('Canvasã‚µã‚¤ã‚º:', canvas.width, 'x', canvas.height);
                console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µã‚¤ã‚º:', player.width, 'x', player.height);
                
                loadStage(1);
                startGame();
                console.log('ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                showError(error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                const startBtn = document.getElementById('startBtn');
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.textContent = 'ã‚²ãƒ¼ãƒ é–‹å§‹';
                }
            }
        }

        // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’è¡¨ç¤º
        function updateLastUpdateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const dateStr = `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
            document.getElementById('lastUpdate').textContent = `æœ€çµ‚æ›´æ–°: ${dateStr}`;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        try {
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.addEventListener('click', handleStart);
                console.log('ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
            } else {
                console.error('ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                showError('ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        } catch (error) {
            console.error('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            showError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                
                // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
                const gameOverModal = document.getElementById('gameOverModal');
                if (gameOverModal.classList.contains('show')) {
                    restartStage();
                    return;
                }
                
                // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸
                const stageClearModal = document.getElementById('stageClearModal');
                if (stageClearModal.classList.contains('show')) {
                    nextStage();
                    return;
                }
                
                // ã‚²ãƒ¼ãƒ ãŒå®Ÿè¡Œä¸­ã§ãªã„å ´åˆã¯ã‚¹ã‚¿ãƒ¼ãƒˆ
                if (!gameRunning) {
                    handleStart();
                } else {
                    jump();
                }
            }
        });

        document.getElementById('jumpBtn').addEventListener('click', jump);
        document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            jump();
        });

        // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œï¼šç”»é¢ã®ã©ã“ã‚’æŠ¼ã—ã¦ã‚‚ã‚¸ãƒ£ãƒ³ãƒ—
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameRunning && !gamePaused) {
                jump();
            }
        });

        // ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ã§ã‚‚ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹
        document.querySelector('.game-container').addEventListener('touchstart', (e) => {
            // ãƒœã‚¿ãƒ³ã‚„ãƒªãƒ³ã‚¯ä»¥å¤–ã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒã—ãŸå ´åˆã®ã¿ã‚¸ãƒ£ãƒ³ãƒ—
            if (e.target === canvas || e.target === document.querySelector('.game-info') || 
                e.target.closest('.game-info') || e.target.closest('.controls')) {
                e.preventDefault();
                if (gameRunning && !gamePaused) {
                    jump();
                }
            }
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒï¼‰
        window.addEventListener('error', function(event) {
            console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
            const errorMsg = event.error ? event.error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + errorMsg;
                errorDiv.style.display = 'block';
            } else {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + errorMsg);
            }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå‡¦ç†ã®Promiseæ‹’å¦:', event.reason);
            const errorMsg = event.reason ? event.reason.toString() : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + errorMsg;
                errorDiv.style.display = 'block';
            } else {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + errorMsg);
            }
        });

        // åˆæœŸåŒ–
        try {
            updateLastUpdateTime();
            console.log('åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');
        } catch (error) {
            console.error('åˆæœŸåŒ–æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            showError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
        
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œã«æœ‰åŠ¹åŒ–ã•ã‚Œã‚‹ï¼‰
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–
        document.addEventListener('click', () => {
            if (!audioContext) {
                initAudioContext();
            }
        }, { once: true });

        document.addEventListener('touchstart', () => {
            if (!audioContext) {
                initAudioContext();
            }
        }, { once: true });
        
        // ã‚²ãƒ¼ãƒ ã¯è‡ªå‹•é–‹å§‹ã—ãªã„ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å¾…ã¤ï¼‰
    </script>
</body>
</html>
